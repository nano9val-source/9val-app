<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>9VAl-BATTL | PRO EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #f39c12; --bg: #000; --card: #1c1c1e; --radius: 18px; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; padding-top: 85px; }
        
        .nav { position: fixed; top: 0; left: 0; right: 0; background: rgba(10,10,10,0.95); backdrop-filter: blur(15px); display: flex; overflow-x: auto; padding: 10px 5px; border-bottom: 0.5px solid #333; z-index: 9999; scrollbar-width: none; }
        .nav-item { color: #777; font-size: 10px; font-weight: 800; text-align: center; white-space: nowrap; padding: 12px 15px; border-radius: 12px; transition: 0.3s; cursor: pointer; flex-shrink: 0; }
        .nav-item.active { color: var(--accent); background: rgba(243,156,18,0.1); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; border: 0.5px solid #333; }
        
        /* –ö–†–ò–¢–ï–†–Ü–á –í –ê–î–ú–Ü–ù–¶–Ü */
        .vote-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .vote-field { background: #222; padding: 8px; border-radius: 10px; border: 1px solid #444; }
        .vote-field label { font-size: 10px; color: var(--accent); display: block; margin-bottom: 4px; text-transform: uppercase; }
        .vote-field input { width: 100%; background: transparent; border: none; color: #fff; font-size: 16px; font-weight: bold; outline: none; }

        .btn-main { background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 15px; width: 100%; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-main:disabled { background: #555; cursor: not-allowed; }
        
        audio { width: 100%; height: 35px; filter: invert(1); margin: 10px 0; }
        input[type="text"], input[type="password"] { width: 100%; padding: 14px; margin-bottom: 10px; background: #222; border: 1px solid #444; border-radius: 12px; color: #fff; box-sizing: border-box; }
        
        .leader-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; }
    </style>
</head>
<body>

    <nav class="nav">
        <div class="nav-item active" onclick="showTab('tab-home', this)">üè† –ì–û–õ–û–í–ù–ê</div>
        <div class="nav-item" onclick="showTab('tab-bracket', this)">üìä –°–Ü–¢–ö–ê</div>
        <div class="nav-item" onclick="showTab('tab-player', this)">üéß –ü–õ–ï–Ñ–†</div>
        <div class="nav-item" onclick="showTab('tab-results', this)">üèÜ –†–ï–ô–¢–ò–ù–ì</div>
        <div class="nav-item" onclick="showTab('tab-judges', this)">üë®‚Äç‚öñÔ∏è –°–£–î–î–Ü</div>
        <div class="nav-item" onclick="showTab('tab-reg', this)">üé§ –£–ß–ê–°–¢–¨</div>
        <div class="nav-item" onclick="showTab('tab-admin', this)">üõ°Ô∏è –ê–î–ú–Ü–ù</div>
    </nav>

    <div id="tab-home" class="tab-content active">
        <div class="card">
            <div style="background:var(--accent); color:#000; padding:5px 15px; border-radius:20px; font-weight:900; display:inline-block; margin-bottom:10px;">–ü–†–ò–ó: 50 000 –ì–†–ù</div>
            <h2>9VAl-BATTL: SEASON 1</h2>
            <p style="color:#aaa; font-size:14px;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –±–∞–ª –∑–∞ –∫–æ–∂–µ–Ω –∫—Ä–∏—Ç–µ—Ä—ñ–π ‚Äî 10. –ü–µ—Ä–µ–º–∞–≥–∞—î –Ω–∞–π—Å–∏–ª—å–Ω—ñ—à–∏–π.</p>
            <button class="btn-main" onclick="showTab('tab-reg')">–ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£</button>
        </div>
    </div>

    <div id="tab-bracket" class="tab-content">
        <h2>–¢—É—Ä–Ω—ñ—Ä–Ω–∞ –°—ñ—Ç–∫–∞</h2>
        <div class="card" style="text-align:center;">–ë–ª–æ–∫ —É —Ä–æ–∑—Ä–æ–±—Ü—ñ...</div>
    </div>

    <div id="tab-player" class="tab-content">
        <h2>–í—Å—ñ —É—á–∞—Å–Ω–∏–∫–∏</h2>
        <div id="player-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>

    <div id="tab-results" class="tab-content">
        <h2>–†–µ–π—Ç–∏–Ω–≥ –±–∞–ª—ñ–≤</h2>
        <div id="ranking-list" class="card"></div>
    </div>

    <div id="tab-admin" class="tab-content">
        <div id="admin-login">
            <div class="card">
                <h2>–í—Ö—ñ–¥ –°—É–¥–¥—ñ</h2>
                <input type="text" id="adm-u" placeholder="–õ–æ–≥—ñ–Ω">
                <input type="password" id="adm-p" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn-main" onclick="login()">–£–í–Ü–ô–¢–ò</button>
            </div>
        </div>
        <div id="admin-work" style="display:none;">
            <h2 id="hello-j">–ü–∞–Ω–µ–ª—å –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è</h2>
            <div id="admin-list"></div>
        </div>
    </div>

    <div id="tab-reg" class="tab-content">
        <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <div class="card">
            <form id="reg-form">
                <input type="text" id="r-name" placeholder="–ù—ñ–∫–Ω–µ–π–º" required>
                <input type="text" id="r-city" placeholder="–ú—ñ—Å—Ç–æ" required>
                <input type="file" id="r-file" accept="audio/*" required>
                <button type="submit" id="r-btn" class="btn-main">–í–Ü–î–ü–†–ê–í–ò–¢–ò</button>
            </form>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbwLlgAFARTIJX3CPPH4eRevaqUDO9gErXoI5PiapR3i2xEJLRFyuRfApYANdVsSHAJ4/exec";
        let user = null;

        function showTab(t, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            if(el) el.classList.add('active');
            load();
        }

        async function load() {
            try {
                const r = await fetch(API + "?action=getData");
                const d = await r.json();
                const u = (d.allUsers || d.users).slice(1);
                const ok = u.filter(i => i[4] === '–ü—Ä–∏–π–Ω—è—Ç–æ');

                // –ü–ª–µ—î—Ä –∑–∞–≥–∞–ª—å–Ω–∏–π
                document.getElementById('player-list').innerHTML = ok.map(i => `
                    <div class="card"><b>${i[1]}</b> (${i[2]})<audio controls src="${i[3]}"></audio></div>
                `).join('');

                // –†–µ–π—Ç–∏–Ω–≥
                const ranked = ok.map(i => ({
                    n: i[1], 
                    s: (((Number(i[5])||0)+(Number(i[6])||0)+(Number(i[7])||0)+(Number(i[8])||0))/4).toFixed(1)
                })).sort((a,b) => b.s - a.s);
                document.getElementById('ranking-list').innerHTML = ranked.map((i, idx) => `
                    <div class="leader-row"><span>${idx+1}. ${i.n}</span><b>${i.s}</b></div>
                `).join('');

                // –ê–¥–º—ñ–Ω–∫–∞ –∑ –ø–ª–µ—î—Ä–æ–º —Ç–∞ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏
                if(user) {
                    document.getElementById('admin-list').innerHTML = u.map((item, idx) => `
                        <div class="card">
                            <b>${item[1]}</b> <small style="color:#777;">[${item[4]}]</small>
                            <audio controls src="${item[3]}"></audio>
                            <div class="vote-group">
                                <div class="vote-field"><label>–¢–µ–∫—Å—Ç</label><input type="number" id="t1-${idx}" value="${item[5]||0}"></div>
                                <div class="vote-field"><label>–§–ª–æ—É</label><input type="number" id="t2-${idx}" value="${item[6]||0}"></div>
                                <div class="vote-field"><label>–ü–æ–¥–∞—á–∞</label><input type="number" id="t3-${idx}" value="${item[7]||0}"></div>
                                <div class="vote-field"><label>–í–∞–π–±</label><input type="number" id="t4-${idx}" value="${item[8]||0}"></div>
                            </div>
                            <button class="btn-main" style="padding:10px; font-size:12px;" onclick="vote(${idx+2}, ${idx})">–ó–ë–ï–†–ï–ì–¢–ò</button>
                        </div>
                    `).join('');
                }
            } catch(e) {}
        }

        async function login() {
            const res = await fetch(API + "?action=getData");
            const d = await res.json();
            const j = d.judges.find(i => i[0] == document.getElementById('adm-u').value && i[1] == document.getElementById('adm-p').value);
            if(j) {
                user = j[2];
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-work').style.display = 'block';
                document.getElementById('hello-j').innerText = "–°—É–¥–¥—è: " + user;
                load();
            } else alert("–ü–æ–º–∏–ª–∫–∞!");
        }

        async function vote(row, i) {
            const p = {
                action: "vote", row: row,
                text: document.getElementById(`t1-${i}`).value,
                flow: document.getElementById(`t2-${i}`).value,
                podacha: document.getElementById(`t3-${i}`).value,
                vibe: document.getElementById(`t4-${i}`).value
            };
            await fetch(API, { method: 'POST', body: JSON.stringify(p) });
            alert("–û—Ü—ñ–Ω–µ–Ω–æ!"); load();
        }

        document.getElementById('reg-form').onsubmit = async (e) => {
            e.preventDefault();
            const b = document.getElementById('r-btn');
            b.disabled = true; b.innerText = "–í–Ü–î–ü–†–ê–í–ö–ê...";
            const f = document.getElementById('r-file').files[0];
            const rd = new FileReader();
            rd.onload = async () => {
                const p = { action: "register", name: document.getElementById('r-name').value, city: document.getElementById('r-city').value, fileData: rd.result.split(',')[1], fileName: f.name, mimeType: f.type };
                await fetch(API, { method: 'POST', body: JSON.stringify(p) });
                alert("–£—Å–ø—ñ—à–Ω–æ!"); location.reload();
            };
            rd.readAsDataURL(f);
        };

        window.onload = load;
    </script>
</body>
</html>
