<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>9VAl BATTLE | PROFESSIONAL SYSTEM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --accent: #ff9f0a; --bg: #000; --card: #1c1c1e; --text: #fff;
            --dim: #8e8e93; --green: #34c759; --red: #ff453a;
            --insta: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; overflow-x: hidden; }

        /* –ù–ê–í–Ü–ì–ê–¶–Ü–Ø - 6 –í–ö–õ–ê–î–û–ö */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(25px);
            display: flex; justify-content: space-around; padding: 12px 5px 35px;
            border-top: 0.5px solid #333; z-index: 10000;
        }
        .tab-item { color: var(--dim); font-size: 9px; text-align: center; flex: 1; cursor: pointer; transition: 0.2s; }
        .tab-item.active { color: var(--accent); transform: scale(1.1); }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #2c2c2e; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* –°–£–î–î–Ü */
        .judge-card { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #2c2c2e; }
        .judge-img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--accent); margin-right: 15px; object-fit: cover; background: #333; }
        .insta-btn { width: 38px; height: 38px; background: var(--insta); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-left: auto; text-decoration: none; }
        .insta-btn img { width: 20px; filter: invert(1); }

        /* –§–û–†–ú–ò –¢–ê –Ü–ù–ü–£–¢–ò */
        input, textarea { width: 100%; padding: 16px; margin: 10px 0; background: #262629; border: 1px solid #3a3a3c; border-radius: 14px; color: #fff; font-size: 16px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }
        .btn { background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 16px; width: 100%; font-weight: 900; cursor: pointer; font-size: 15px; transition: 0.3s; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn:disabled { background: #3a3a3c; color: #8e8e93; cursor: not-allowed; }

        /* –ü–õ–ï–Ñ–† –¢–ê –†–ï–ô–¢–ò–ù–ì */
        audio { width: 100%; height: 35px; filter: invert(1); margin-top: 15px; border-radius: 8px; }
        .score-badge { position: absolute; top: 20px; right: 20px; background: var(--accent); color: #000; padding: 4px 10px; border-radius: 8px; font-weight: 900; font-size: 16px; }
        .rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .rank-table td { padding: 15px; border-bottom: 1px solid #2c2c2e; }

        /* –ê–î–ú–Ü–ù-–ü–ê–ù–ï–õ–¨ (4 –û–¶–Ü–ù–ö–ò) */
        .vote-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 15px 0; }
        .vote-item { background: #1c1c1e; padding: 10px; border-radius: 15px; border: 1px solid #3a3a3c; text-align: center; }
        .vote-item label { font-size: 10px; color: var(--dim); display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .vote-item input { background: transparent; border: none; text-align: center; font-size: 24px; font-weight: 900; color: var(--accent); margin: 0; padding: 0; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="p-home" class="page active">
        <h1 id="cms-title" style="font-size: 34px; margin-bottom: 5px;">9VAl BATTLE</h1>
        <p style="color: var(--accent); font-weight: 900; margin-bottom: 25px;">SEASON #1</p>
        <div class="glass-card">
            <h3 id="cms-prize" style="margin-top:0; color:var(--accent)">–ü–†–ò–ó: 50 000 –ì–†–ù</h3>
            <p id="cms-desc" style="line-height: 1.6; color: #d1d1d6;">–¢—É—Ç –Ω–∞—Ä–æ–¥–∂—É—é—Ç—å—Å—è –ª–µ–≥–µ–Ω–¥–∏. –†–µ—î—Å—Ç—Ä—É–π—Å—è, –∑–∞–≤–∞–Ω—Ç–∞–∂—É–π —Ç—Ä–µ–∫ —ñ –Ω–µ—Ö–∞–π —Ç–≤—ñ–π –≥–æ–ª–æ—Å –ø–æ—á—É—î –≤—Å—è –∫—Ä–∞—ó–Ω–∞.</p>
        </div>
        <div id="status-box" class="glass-card" style="text-align:center; border-color: var(--green);">
            <b style="color: var(--green)">–°–¢–ê–¢–£–°: –ü–†–ò–ô–û–ú –¢–†–ï–ö–Ü–í –í–Ü–î–ö–†–ò–¢–û</b>
        </div>
    </div>

    <div id="p-judges" class="page">
        <h2>–ñ–£–†–Ü –ë–ê–¢–õ–£</h2>
        <div class="glass-card">
            <div class="judge-card">
                <img src="ID_1" class="judge-img" onerror="this.src='https://via.placeholder.com/60'">
                <div><b>TONY MUS1CZ</b><br><small>Sound Producer</small></div>
                <a href="https://instagram.com/t0ny_mus1cz_prod/" class="insta-btn">üì∏</a>
            </div>
            <div class="judge-card">
                <img src="ID_2" class="judge-img" onerror="this.src='https://via.placeholder.com/60'">
                <div><b>NeedForRap</b><br><small>Rap Analyst</small></div>
                <a href="https://instagram.com/aleksandr_kozlovvvvv/" class="insta-btn">üì∏</a>
            </div>
            <div class="judge-card">
                <img src="ID_3" class="judge-img" onerror="this.src='https://via.placeholder.com/60'">
                <div><b>Nano</b><br><small>CEO 9VAl</small></div>
                <a href="https://instagram.com/nano9val/" class="insta-btn">üì∏</a>
            </div>
            <div class="judge-row" style="display:flex; align-items:center; padding: 15px 0;">
                <img src="ID_4" class="judge-img" onerror="this.src='https://via.placeholder.com/60'">
                <div><b>KAZHAN</b><br><small>Artist</small></div>
                <a href="https://instagram.com/ka.zhan_/" class="insta-btn">üì∏</a>
            </div>
        </div>
    </div>

    <div id="p-player" class="page">
        <h2>–£–ß–ê–°–ù–ò–ö–ò</h2>
        <input type="text" id="search-bar" placeholder="üîç –ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º..." oninput="app.render()">
        <div id="player-container"></div>
    </div>

    <div id="p-stats" class="page">
        <h2>–†–ï–ô–¢–ò–ù–ì–û–í–ê –¢–ê–ë–õ–ò–¶–Ø</h2>
        <div class="glass-card" style="padding: 0;">
            <table class="rank-table" id="rank-data"></table>
        </div>
    </div>

    <div id="p-reg" class="page">
        <h2>–ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£</h2>
        <div class="glass-card">
            <p id="cms-rules" style="font-size: 13px; color: var(--dim); margin-bottom: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂—É–π—Ç–µ —Ñ–∞–π–ª MP3. –¢—ñ–ª—å–∫–∏ –∞–≤—Ç–æ—Ä—Å—å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç.</p>
            <form id="upload-form">
                <input type="text" id="user-nick" placeholder="–¢–≤—ñ–π –ù—ñ–∫–Ω–µ–π–º" required>
                <input type="text" id="user-city" placeholder="–¢–≤–æ—î –ú—ñ—Å—Ç–æ" required>
                <label style="font-size: 12px; color: var(--accent); margin-top: 10px; display: block;">–§–ê–ô–õ (MP3):</label>
                <input type="file" id="user-file" accept="audio/mpeg" required>
                
                <div style="display:flex; gap:12px; margin: 25px 0; align-items: flex-start;">
                    <input type="checkbox" id="user-agree" style="width:24px; height:24px;" onchange="document.getElementById('submit-btn').disabled = !this.checked">
                    <label style="font-size: 12px; color: #8e8e93; line-height: 1.4;">–Ø –∑–≥–æ–¥–µ–Ω –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –±–∞—Ç–ª—É —Ç–∞ –¥–∞—é –∑–≥–æ–¥—É –Ω–∞ –æ–±—Ä–æ–±–∫—É –º–æ—ó—Ö –¥–∞–Ω–∏—Ö.</label>
                </div>
                
                <button type="submit" id="submit-btn" class="btn" disabled>–í–Ü–î–ü–†–ê–í–ò–¢–ò –¢–†–ï–ö</button>
            </form>
        </div>
    </div>

    <div id="p-admin" class="page">
        <div id="auth-section">
            <div class="glass-card">
                <h3>–í–•–Ü–î –î–õ–Ø –ñ–£–†–Ü</h3>
                <input type="text" id="login-u" placeholder="–õ–æ–≥—ñ–Ω">
                <input type="password" id="login-p" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn" onclick="app.login()">–£–í–Ü–ô–¢–ò –ü–ê–ù–ï–õ–¨</button>
            </div>
        </div>
        
        <div id="admin-controls" style="display:none;">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="padding:10px; font-size:12px;" onclick="app.setAdmMode('vote')">–û–¶–Ü–ù–ö–ò</button>
                <button class="btn" style="padding:10px; font-size:12px; background:#333; color:#fff;" onclick="app.setAdmMode('cms')">–ö–û–ù–¢–ï–ù–¢</button>
            </div>

            <div id="adm-vote-view">
                <div id="moderation-list"></div>
            </div>

            <div id="adm-cms-view" style="display:none;">
                <div class="glass-card">
                    <label>–ù–∞–∑–≤–∞ –±–∞—Ç–ª—É</label><input type="text" id="edit-title">
                    <label>–ü—Ä–∏–∑</label><input type="text" id="edit-prize">
                    <label>–û–ø–∏—Å</label><textarea id="edit-desc"></textarea>
                    <label>–ü—Ä–∞–≤–∏–ª–∞</label><textarea id="edit-rules"></textarea>
                    <button class="btn" onclick="app.saveCMS()">–ó–ë–ï–†–ï–ì–¢–ò –í–°–Ü –¢–ï–ö–°–¢–ò</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="app.nav('home', this)"><span class="tab-icon">üè†</span>–ì–û–õ–û–í–ù–ê</div>
        <div class="tab-item" onclick="app.nav('judges', this)"><span class="tab-icon">‚öñÔ∏è</span>–°–£–î–î–Ü</div>
        <div class="tab-item" onclick="app.nav('player', this)"><span class="tab-icon">üéß</span>–ü–õ–ï–Ñ–†</div>
        <div class="tab-item" onclick="app.nav('stats', this)"><span class="tab-icon">üìä</span>–†–ï–ô–¢–ò–ù–ì</div>
        <div class="tab-item" onclick="app.nav('reg', this)"><span class="tab-icon">üé§</span>–£–ß–ê–°–¢–¨</div>
        <div class="tab-item" onclick="app.nav('admin', this)"><span class="tab-icon">üõ°Ô∏è</span>–ê–î–ú–Ü–ù</div>
    </nav>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbwLlgAFARTIJX3CPPH4eRevaqUDO9gErXoI5PiapR3i2xEJLRFyuRfApYANdVsSHAJ4/exec";
        
        const app = {
            data: null, user: null, admMode: 'vote',
            nav(id, el) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.getElementById('p-' + id).classList.add('active');
                el.classList.add('active');
            },
            async load() {
                const r = await fetch(API + "?action=getData");
                this.data = await r.json();
                this.render();
            },
            calc(u) {
                const s = (parseFloat(u[5])||0) + (parseFloat(u[6])||0) + (parseFloat(u[7])||0) + (parseFloat(u[8])||0);
                return s > 0 ? (s/4).toFixed(1) : "0.0";
            },
            render() {
                const users = (this.data.allUsers || []).slice(1);
                const approved = users.filter(u => u[4] === '–ü—Ä–∏–π–Ω—è—Ç–æ');
                const search = document.getElementById('search-bar').value.toLowerCase();

                // Player
                document.getElementById('player-container').innerHTML = approved.filter(u => u[1].toLowerCase().includes(search)).map(u => `
                    <div class="glass-card">
                        <span class="score-badge">${this.calc(u)}</span>
                        <b>${u[1]}</b><br><small style="color:var(--dim)">${u[2]}</small>
                        <audio controls src="https://docs.google.com/uc?export=download&id=${u[3].split('id=')[1]}"></audio>
                    </div>
                `).join('');

                // Stats
                const sorted = [...approved].sort((a,b) => this.calc(b) - this.calc(a));
                document.getElementById('rank-data').innerHTML = sorted.map((u, i) => `
                    <tr><td style="color:var(--accent); font-weight:bold; width:40px">#${i+1}</td><td>${u[1]}</td><td align="right"><b>${this.calc(u)}</b></td></tr>
                `).join('');

                // Admin
                if(this.user) {
                    document.getElementById('moderation-list').innerHTML = users.map((u, i) => `
                        <div class="glass-card">
                            <b>${u[1]}</b> <small>[${u[4]||'–ù–û–í–ò–ô'}]</small>
                            <div class="vote-grid">
                                <div class="vote-item"><label>–¢–µ–∫—Å—Ç</label><input type="number" id="v1-${i}" value="${u[5]||0}"></div>
                                <div class="vote-item"><label>–§–ª–æ—É</label><input type="number" id="v2-${i}" value="${u[6]||0}"></div>
                                <div class="vote-item"><label>–ü–æ–¥–∞—á–∞</label><input type="number" id="v3-${i}" value="${u[7]||0}"></div>
                                <div class="vote-item"><label>–í–∞–π–±</label><input type="number" id="v4-${i}" value="${u[8]||0}"></div>
                            </div>
                            <button class="btn" onclick="app.saveVotes(${i+2}, ${i})">–ó–ë–ï–†–ï–ì–¢–ò</button>
                            ${u[4]!=='–ü—Ä–∏–π–Ω—è—Ç–æ' ? `<button class="btn" style="margin-top:5px; background:var(--green); color:#fff" onclick="app.status(${i+2}, '–ü—Ä–∏–π–Ω—è—Ç–æ')">–î–û–ü–£–°–¢–ò–¢–ò</button>` : ''}
                        </div>
                    `).join('');
                }
            },
            async login() {
                const u = document.getElementById('login-u').value, p = document.getElementById('login-p').value;
                const j = this.data.judges.find(x => x[0] == u && x[1] == p);
                if(j) {
                    this.user = j[2];
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('admin-controls').style.display = 'block';
                    this.render();
                }
            },
            setAdmMode(m) {
                this.admMode = m;
                document.getElementById('adm-vote-view').style.display = m === 'vote' ? 'block' : 'none';
                document.getElementById('adm-cms-view').style.display = m === 'cms' ? 'block' : 'none';
            },
            async saveVotes(row, i) {
                const payload = {
                    action: "vote", row: row,
                    text: document.getElementById('v1-'+i).value,
                    flow: document.getElementById('v2-'+i).value,
                    podacha: document.getElementById('v3-'+i).value,
                    vibe: document.getElementById('v4-'+i).value
                };
                await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
                alert("–ó–±–µ—Ä–µ–∂–µ–Ω–æ!"); this.load();
            },
            async status(row, st) {
                await fetch(`${API}?action=vote&row=${row}&status=${st}`);
                this.load();
            }
        };

        document.getElementById('upload-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = `<span class="loader"></span> –û–ë–†–û–ë–ö–ê...`; btn.disabled = true;
            
            const file = document.getElementById('user-file').files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                const payload = {
                    action: "register",
                    name: document.getElementById('user-nick').value,
                    city: document.getElementById('user-city').value,
                    fileData: reader.result.split(',')[1],
                    fileName: file.name
                };
                await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
                alert("–¢–†–ï–ö –í–Ü–î–ü–†–ê–í–õ–ï–ù–û! –ß–ï–ö–ê–ô–¢–ï –ù–ê –ú–û–î–ï–†–ê–¶–Ü–Æ.");
                location.reload();
            };
            reader.readAsDataURL(file);
        };

        window.onload = () => { window.Telegram.WebApp.expand(); app.load(); };
    </script>
</body>
</html>
