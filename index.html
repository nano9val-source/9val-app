<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Battle Arena</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #eee; margin: 0; padding: 15px; padding-top: 70px; }
        h2 { color: #f39c12; border-bottom: 2px solid #f39c12; padding-bottom: 5px; margin-top: 0; }
        
        /* –í–ï–†–•–ù–Ø –ù–ê–í–Ü–ì–ê–¶–Ü–Ø */
        .nav { position: fixed; top: 0; left: 0; right: 0; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-bottom: 1px solid #333; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .nav-item { color: #666; text-decoration: none; font-size: 13px; font-weight: bold; text-align: center; flex: 1; padding: 10px 0; transition: 0.3s; }
        .nav-item.active { color: #f39c12; border-bottom: 2px solid #f39c12; background: rgba(243, 156, 18, 0.1); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* –ö–∞—Ä—Ç–∫–∏ —Ç–∞ –ü–ª–µ—î—Ä */
        .card { background: #181818; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .name { font-size: 18px; font-weight: bold; color: #fff; }
        audio { width: 100%; height: 35px; margin: 10px 0; border-radius: 8px; }
        
        /* –§–æ—Ä–º–∏ */
        input { background: #222; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 12px; }
        button { background: #f39c12; color: #000; border: none; padding: 14px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }

        /* –ê–¥–º—ñ–Ω–∫–∞ */
        .judge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .judge-grid label { font-size: 11px; color: #aaa; text-transform: uppercase; }
    </style>
</head>
<body>

    <nav class="nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="showTab('tab-results', this)">üèÜ –†–ï–ô–¢–ò–ù–ì</a>
        <a href="javascript:void(0)" class="nav-item" onclick="showTab('tab-reg', this)">üé§ –£–ß–ê–°–¢–¨</a>
        <a href="javascript:void(0)" class="nav-item" onclick="showTab('tab-admin', this)">üõ°Ô∏è –ê–î–ú–Ü–ù</a>
    </nav>

    <div id="tab-results" class="tab-content active">
        <h2>üèÜ –¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Ç–∞–±–ª–∏—Ü—è</h2>
        <div id="results-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>

    <div id="tab-reg" class="tab-content">
        <h2>üé§ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <form id="reg-form">
            <input type="text" id="reg-name" placeholder="–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º" required>
            <input type="text" id="reg-city" placeholder="–¢–≤–æ—î –º—ñ—Å—Ç–æ" required>
            <input type="file" id="reg-file" accept="audio/*" required>
            <button type="submit" id="btn-submit">–í–Ü–î–ü–†–ê–í–ò–¢–ò –¢–†–ï–ö</button>
        </form>
    </div>

    <div id="tab-admin" class="tab-content">
        <div id="login-form">
            <h2>üîê –í—Ö—ñ–¥ –¥–ª—è —Å—É–¥–¥—ñ–≤</h2>
            <input type="text" id="log-user" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="log-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button>
        </div>
        <div id="admin-panel" style="display:none;">
            <h2 id="judge-name">–°—É–¥–¥—è: </h2>
            <div id="admin-list"></div>
        </div>
    </div>

    <script>
        // –¢–≤–æ—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        const API_URL = "https://script.google.com/macros/s/AKfycbzO2qKA5Tk5946g1EiImQueRoxNYBprZpM6kY5VIFRG8dZyai3i56A_lTXzV-dGt8T9/exec";
        let currentUser = null;

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'tab-results') loadData();
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è Google –î–∏—Å–∫ —É –ø—Ä—è–º–µ –¥–ª—è –ø–ª–µ—î—Ä–∞
        function formatDriveUrl(url) {
            if(!url) return "";
            let id = "";
            if(url.includes('id=')) id = url.split('id=')[1].split('&')[0];
            else if(url.includes('file/d/')) id = url.split('file/d/')[1].split('/')[0];
            return id ? `https://docs.google.com/uc?export=download&id=${id}` : url;
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                
                // –†–ï–ô–¢–ò–ù–ì (–ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–∏—Ö, —É –∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å "–ü—Ä–∏–π–Ω—è—Ç–æ")
                const acceptedUsers = data.users.filter(u => u[5] === "–ü—Ä–∏–π–Ω—è—Ç–æ");
                document.getElementById('results-list').innerHTML = acceptedUsers.length > 0 ? 
                acceptedUsers.map(u => `
                    <div class="card">
                        <div class="name">${u[1]} <span style="font-size:12px; color:#f39c12; float:right;">üìç ${u[2]}</span></div>
                        <audio controls src="${formatDriveUrl(u[3])}"></audio>
                    </div>
                `).join('') : "<p style='text-align:center; color:#666;'>–£—á–∞—Å–Ω–∏–∫—ñ–≤ –ø–æ–∫–∏ –Ω–µ –ø—Ä–∏–π–Ω—è—Ç–æ</p>";

                // –ê–î–ú–Ü–ù–ö–ê
                if(currentUser) {
                    const allUsers = data.users.slice(1); // –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    document.getElementById('admin-list').innerHTML = allUsers.map((u, i) => `
                        <div class="card">
                            <div class="name">${u[1]} [${u[5]}]</div>
                            <audio controls src="${formatDriveUrl(u[3])}"></audio>
                            <div class="judge-grid">
                                <div><label>–¢–µ–∫—Å—Ç</label><input type="number" id="t-${i}" min="0" max="10" value="0"></div>
                                <div><label>–§–ª–æ—É</label><input type="number" id="f-${i}" min="0" max="10" value="0"></div>
                                <div><label>–ü–æ–¥–∞—á–∞</label><input type="number" id="p-${i}" min="0" max="10" value="0"></div>
                                <div><label>–í–∞–π–±</label><input type="number" id="v-${i}" min="0" max="10" value="0"></div>
                            </div>
                            <button style="margin-top:10px; font-size:12px;" onclick="alert('–ë–∞–ª–∏ –¥–ª—è ${u[1]} –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ!')">–ó–ë–ï–†–ï–ì–¢–ò –û–¶–Ü–ù–ö–ò</button>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function tryLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            const judge = data.judges.find(j => j[0] == u && j[1] == p);
            
            if(judge) {
                currentUser = judge[2];
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('judge-name').innerText = "–°—É–¥–¥—è: " + currentUser;
                loadData();
            } else { alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É! –ü–µ—Ä–µ–≤—ñ—Ä –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å."); }
        }

        document.getElementById('reg-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...";
            btn.disabled = true;

            const file = document.getElementById('reg-file').files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                const payload = {
                    name: document.getElementById('reg-name').value,
                    city: document.getElementById('reg-city').value,
                    fileData: reader.result.split(',')[1],
                    fileName: file.name,
                    mimeType: file.type
                };
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert("–¢—Ä–µ–∫ —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! –ß–µ–∫–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.");
                    document.getElementById('reg-form').reset();
                } catch(err) { alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ"); }
                btn.innerText = "–í–Ü–î–ü–†–ê–í–ò–¢–ò –¢–†–ï–ö";
                btn.disabled = false;
            };
            reader.readAsDataURL(file);
        };

        window.onload = loadData;
    </script>
</body>
</html>
