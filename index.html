<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BATTLE ARENA | 50,000 UAH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #f39c12; --bg: #000; --card: #1c1c1e; --radius: 22px; }
        
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; padding-top: 85px; }
        
        /* –ú–ï–ù–Æ */
        .nav { position: fixed; top: 0; left: 0; right: 0; background: rgba(10,10,10,0.95); backdrop-filter: blur(20px); display: flex; overflow-x: auto; padding: 12px 5px; border-bottom: 0.5px solid #333; z-index: 9999; scrollbar-width: none; }
        .nav-item { color: #777; font-size: 10px; font-weight: 800; text-align: center; white-space: nowrap; padding: 10px 14px; border-radius: 15px; transition: 0.3s; cursor: pointer; flex-shrink: 0; }
        .nav-item.active { color: var(--accent); background: rgba(243,156,18,0.1); }

        h2 { font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #fff; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* –ö–ê–†–¢–ö–ò */
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; border: 0.5px solid #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* –ü–õ–ï–Ñ–† */
        .track-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .track-name { font-weight: 700; font-size: 17px; }
        .track-city { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        audio { width: 100%; height: 35px; border-radius: 10px; filter: invert(1) hue-rotate(180deg); margin-top: 5px; }

        /* –°–£–î–î–Ü–í–°–¨–ö–ê –°–Ü–¢–ö–ê */
        .judge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; background: #252527; padding: 12px; border-radius: 15px; }
        .judge-grid label { font-size: 9px; color: #888; text-transform: uppercase; margin-left: 5px; }
        .judge-grid input { background: #111; border: 1px solid #444; color: var(--accent); padding: 8px; border-radius: 10px; text-align: center; font-weight: 700; margin-bottom: 5px; }

        /* –ö–ù–û–ü–ö–ò –¢–ê –Ü–ù–ü–£–¢–ò */
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; box-sizing: border-box; padding:15px; border-radius:15px; background:#222; border:1px solid #444; color:#fff; }
        .btn-main { background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 20px; width: 100%; font-weight: 800; font-size: 15px; margin-top: 10px; cursor: pointer; }
        
        /* –°–¢–ò–õ–¨ –°–£–î–î–Ü–í */
        .judge-box { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .j-img { width: 60px; height: 60px; border-radius: 50%; background: #333; border: 2px solid var(--accent); }

        /* –†–ï–ô–¢–ò–ù–ì */
        .rank-item { display: flex; justify-content: space-between; align-items: center; }
        .rank-score { font-size: 22px; font-weight: 900; color: var(--accent); }
    </style>
</head>
<body>

    <nav class="nav">
        <div class="nav-item active" onclick="showTab('tab-home', this)">üè† –Ü–ù–§–û</div>
        <div class="nav-item" onclick="showTab('tab-player', this)">üéß –ü–õ–ï–Ñ–†</div>
        <div class="nav-item" onclick="showTab('tab-results', this)">üèÜ –†–ï–ô–¢–ò–ù–ì</div>
        <div class="nav-item" onclick="showTab('tab-judges', this)">üë®‚Äç‚öñÔ∏è –°–£–î–î–Ü</div>
        <div class="nav-item" onclick="showTab('tab-reg', this)">üé§ –£–ß–ê–°–¢–¨</div>
        <div class="nav-item" onclick="showTab('tab-admin', this)">üõ°Ô∏è –ê–î–ú–Ü–ù</div>
    </nav>

    <div id="tab-home" class="tab-content active">
        <div class="card">
            <div style="background: var(--accent); color:#000; padding:4px 12px; border-radius:20px; display:inline-block; font-size:12px; font-weight:900; margin-bottom:10px;">–ì–†–ê–ù-–ü–†–Ü: 50 000 –ì–†–ù</div>
            <h2>BATTLE ARENA</h2>
            <p style="color:#aaa; font-size:14px; line-height:1.5;">–¶–µ –±–∏—Ç–≤–∞ –∑–∞ –∑–≤–∞–Ω–Ω—è –Ω–∞–π–∫—Ä–∞—â–æ–≥–æ. –¢—ñ–ª—å–∫–∏ —á–∏—Å—Ç–∏–π —Å–∫—ñ–ª. –ó–∞–≤–∞–Ω—Ç–∞–∂—É–π —Å–≤—ñ–π –≤—ñ–¥–±—ñ—Ä–∫–æ–≤–∏–π —Ç—Ä–µ–∫ —Ç–∞ –ø—Ä–æ—Ö–æ–¥—å —É —Ç–æ–ø-16.</p>
            <button class="btn-main" onclick="showTab('tab-reg')">–ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£</button>
        </div>
    </div>

    <div id="tab-player" class="tab-content">
        <h2>–í—Å—ñ —Ç—Ä–µ–∫–∏</h2>
        <div id="full-player-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>

    <div id="tab-results" class="tab-content">
        <h2>–¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Ç–∞–±–ª–∏—Ü—è</h2>
        <div id="ranking-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É...</div>
    </div>

    <div id="tab-judges" class="tab-content">
        <h2>–°—É–¥–¥—ñ</h2>
        <div class="card">
            <div class="judge-box"><div class="j-img"></div><div><b>MC Solomon</b><br><small>–¢–µ–∫—Å—Ç–∏ —Ç–∞ —Å–µ–Ω—Å–∏</small></div></div>
            <div class="judge-box"><div class="j-img"></div><div><b>Beatmaker Flow</b><br><small>–†–∏—Ç–º—ñ–∫–∞ —Ç–∞ –≤–∞–π–±</small></div></div>
        </div>
    </div>

    <div id="tab-reg" class="tab-content">
        <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <form id="reg-form">
            <input type="text" id="reg-name" placeholder="–¢–≤—ñ–π –Ω—ñ–∫" required style="margin-bottom:10px;">
            <input type="text" id="reg-city" placeholder="–ú—ñ—Å—Ç–æ" required style="margin-bottom:10px;">
            <label style="font-size:12px; color:#666; display:block; margin-top:10px;">–§–∞–π–ª —Ç—Ä–µ–∫—É (MP3):</label>
            <input type="file" id="reg-file" accept="audio/*" required style="margin-top:10px; margin-bottom:20px;">
            <button type="submit" id="btn-submit" class="btn-main">–í–Ü–î–ü–†–ê–í–ò–¢–ò –¢–†–ï–ö</button>
        </form>
    </div>

    <div id="tab-admin" class="tab-content">
        <div id="login-form">
            <h2>–í—Ö—ñ–¥ –¥–ª—è —Å—É–¥–¥—ñ</h2>
            <input type="text" id="log-user" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom:10px;">
            <input type="password" id="log-pass" placeholder="–ü–∞—Ä–æ–ª—å" style="margin-bottom:10px;">
            <button onclick="tryLogin()" class="btn-main">–£–í–Ü–ô–¢–ò</button>
        </div>
        <div id="admin-panel" style="display:none;">
            <h2 id="judge-name-title">–ü–∞–Ω–µ–ª—å –æ—Ü—ñ–Ω–∫–∏</h2>
            <div id="admin-vote-list"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwLlgAFARTIJX3CPPH4eRevaqUDO9gErXoI5PiapR3i2xEJLRFyuRfApYANdVsSHAJ4/exec";
        let currentUser = null;

        function showTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(el) el.classList.add('active');
            loadData();
        }

        function formatDriveUrl(url) {
            if(!url) return "";
            let id = url.includes('id=') ? url.split('id=')[1].split('&')[0] : url.split('file/d/')[1]?.split('/')[0];
            return id ? `https://docs.google.com/uc?export=download&id=${id}` : url;
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                const users = data.users.slice(1); 

                // 1. –ü–õ–ï–Ñ–†
                document.getElementById('full-player-list').innerHTML = users.map(u => `
                    <div class="card">
                        <div class="track-info">
                            <span class="track-name">${u[1]}</span>
                            <span class="track-city">${u[2]}</span>
                        </div>
                        <audio controls src="${formatDriveUrl(u[3])}"></audio>
                    </div>
                `).join('');

                // 2. –†–ï–ô–¢–ò–ù–ì (–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è)
                const ranked = users.map(u => {
                    let avg = ((Number(u[5])||0) + (Number(u[6])||0) + (Number(u[7])||0) + (Number(u[8])||0)) / 4;
                    return { name: u[1], city: u[2], score: avg.toFixed(1) };
                }).sort((a, b) => b.score - a.score);

                document.getElementById('ranking-list').innerHTML = ranked.map((u, i) => `
                    <div class="card rank-item">
                        <div><b>${i+1}. ${u.name}</b><br><small>${u.city}</small></div>
                        <div class="rank-score">${u.score}</div>
                    </div>
                `).join('');

                // 3. –ê–î–ú–Ü–ù–ö–ê
                if(currentUser) {
                    document.getElementById('admin-vote-list').innerHTML = users.map((u, index) => `
                        <div class="card">
                            <div class="track-name">${u[1]}</div>
                            <audio controls src="${formatDriveUrl(u[3])}"></audio>
                            <div class="judge-grid">
                                <div><label>–¢–µ–∫—Å—Ç</label><input type="number" id="txt-${index}" value="${u[5] || 0}"></div>
                                <div><label>–§–ª–æ—É</label><input type="number" id="flw-${index}" value="${u[6] || 0}"></div>
                                <div><label>–ü–æ–¥–∞—á–∞</label><input type="number" id="pdc-${index}" value="${u[7] || 0}"></div>
                                <div><label>–í–∞–π–±</label><input type="number" id="vb-${index}" value="${u[8] || 0}"></div>
                            </div>
                            <button class="btn-main" style="padding:10px; font-size:12px;" onclick="saveScore(${index + 2}, ${index})">–ó–ë–ï–†–ï–ì–¢–ò –û–¶–Ü–ù–ö–ò</button>
                        </div>
                    `).join('');
                }
            } catch (e) { console.log(e); }
        }

        async function saveScore(rowId, index) {
            const btn = event.target;
            btn.innerText = "–ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø..."; btn.disabled = true;

            const payload = {
                action: "vote",
                row: rowId,
                text: document.getElementById(`txt-${index}`).value,
                flow: document.getElementById(`flw-${index}`).value,
                podacha: document.getElementById(`pdc-${index}`).value,
                vibe: document.getElementById(`vb-${index}`).value
            };

            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("–û—Ü—ñ–Ω–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!");
                loadData();
            } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞!"); }
            finally { btn.innerText = "–ó–ë–ï–†–ï–ì–¢–ò –û–¶–Ü–ù–ö–ò"; btn.disabled = false; }
        }

        async function tryLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            const res = await fetch(API_URL + "?action=getData");
            const data = await res.json();
            const judge = data.judges.find(j => j[0] == u && j[1] == p);
            if(judge) {
                currentUser = judge[2];
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('judge-name-title').innerText = "–°—É–¥–¥—è: " + currentUser;
                loadData();
            } else { alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É!"); }
        }

        document.getElementById('reg-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "–í–Ü–î–ü–†–ê–í–õ–Ø–Ñ–ú–û..."; btn.disabled = true;
            const file = document.getElementById('reg-file').files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                const payload = {
                    action: "register",
                    name: document.getElementById('reg-name').value,
                    city: document.getElementById('reg-city').value,
                    fileData: reader.result.split(',')[1],
                    fileName: file.name,
                    mimeType: file.type
                };
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("–¢—Ä–µ–∫ –ø—Ä–∏–π–Ω—è—Ç–æ –Ω–∞ –≤—ñ–¥–±—ñ—Ä!");
                location.reload();
            };
            reader.readAsDataURL(file);
        };

        window.onload = loadData;
    </script>
</body>
</html>
