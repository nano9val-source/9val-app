<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Battle Arena Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #f39c12; --bg: #000; --card: #1c1c1e; --radius: 20px; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; padding-top: 75px; -webkit-font-smoothing: antialiased; }
        
        /* –í–ï–†–•–ù–Ø –ù–ê–í–Ü–ì–ê–¶–Ü–Ø */
        .nav { position: fixed; top: 0; left: 0; right: 0; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px 5px; border-bottom: 0.5px solid #333; z-index: 1000; }
        .nav-item { color: #888; text-decoration: none; font-size: 11px; font-weight: 700; text-align: center; flex: 1; padding: 10px 0; border-radius: 14px; transition: 0.2s; }
        .nav-item.active { color: var(--accent); background: rgba(255,255,255,0.08); }

        h2 { font-size: 26px; font-weight: 800; margin-bottom: 20px; letter-spacing: -0.5px; }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* –ö–ê–†–¢–ö–ò (iOS Style) */
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; border: 0.5px solid #38383a; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .name { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .city-tag { font-size: 13px; color: var(--accent); font-weight: 600; margin-bottom: 12px; }
        
        /* –ü–õ–ï–Ñ–† */
        audio { width: 100%; height: 40px; margin: 15px 0; border-radius: 12px; filter: invert(100%) hue-rotate(180deg) brightness(1.4); }
        
        /* –Ü–ù–ü–£–¢–ò –¢–ê –ö–ù–û–ü–ö–ò (–ö—Ä—É–≥–ª—ñ) */
        input { background: #2c2c2e; border: none; color: #fff; padding: 16px; border-radius: 16px; width: 100%; box-sizing: border-box; margin-bottom: 15px; font-size: 16px; }
        button { background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 30px; width: 100%; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.96); }

        /* –ß–ï–ö–ë–û–ö–° */
        .rules-row { display: flex; align-items: center; gap: 12px; margin: 10px 0 25px 0; font-size: 14px; color: #aaa; line-height: 1.4; }
        .rules-row input[type="checkbox"] { width: 24px; height: 24px; margin: 0; accent-color: var(--accent); cursor: pointer; }

        /* –°–Ü–¢–ö–ê –î–õ–Ø –û–¶–Ü–ù–û–ö */
        .judge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; background: #2c2c2e; padding: 15px; border-radius: 15px; }
        .judge-grid label { font-size: 10px; color: #999; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .judge-grid input { margin-bottom: 0; padding: 10px; border-radius: 10px; text-align: center; font-weight: 700; }
    </style>
</head>
<body>

    <nav class="nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="showTab('tab-results', this)">üèÜ –†–ï–ô–¢–ò–ù–ì</a>
        <a href="javascript:void(0)" class="nav-item" onclick="showTab('tab-reg', this)">üé§ –£–ß–ê–°–¢–¨</a>
        <a href="javascript:void(0)" class="nav-item" onclick="showTab('tab-admin', this)">üõ°Ô∏è –ê–î–ú–Ü–ù</a>
    </nav>

    <div id="tab-results" class="tab-content active">
        <h2>–¢—É—Ä–Ω—ñ—Ä–Ω–∞ —Ç–∞–±–ª–∏—Ü—è</h2>
        <div id="results-list">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤...</div>
    </div>

    <div id="tab-reg" class="tab-content">
        <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
        <form id="reg-form">
            <input type="text" id="reg-name" placeholder="–¢–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º" required>
            <input type="text" id="reg-city" placeholder="–¢–≤–æ—î –º—ñ—Å—Ç–æ" required>
            <label style="font-size: 13px; color: #888; display: block; margin-bottom: 8px;">–í–∏–±–µ—Ä–∏ —Ç—Ä–µ–∫ (–∞—É–¥—ñ–æ):</label>
            <input type="file" id="reg-file" accept="audio/*" required style="background: transparent; padding: 0;">
            
            <div class="rules-row">
                <input type="checkbox" id="reg-rules" required>
                <span>–Ø –∑–≥–æ–¥–µ–Ω –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –±–∞—Ç—Ç–ª—É —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è–º —Å—É–¥–¥—ñ–≤</span>
            </div>
            
            <button type="submit" id="btn-submit">–ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£</button>
        </form>
    </div>

    <div id="tab-admin" class="tab-content">
        <div id="login-form">
            <h2>–í—Ö—ñ–¥ –¥–ª—è —Å—É–¥–¥—ñ</h2>
            <input type="text" id="log-user" placeholder="–õ–æ–≥—ñ–Ω">
            <input type="password" id="log-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="tryLogin()">–£–í–Ü–ô–¢–ò</button>
        </div>
        <div id="admin-panel" style="display:none;">
            <h2 id="judge-name">–ü–∞–Ω–µ–ª—å —Å—É–¥–¥—ñ</h2>
            <div id="admin-list"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzO2qKA5Tk5946g1EiImQueRoxNYBprZpM6kY5VIFRG8dZyai3i56A_lTXzV-dGt8T9/exec";
        let currentUser = null;

        function showTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'tab-results' || (id === 'tab-admin' && currentUser)) loadData();
        }

        function formatDriveUrl(url) {
            if(!url) return "";
            let id = "";
            if(url.includes('id=')) id = url.split('id=')[1].split('&')[0];
            else if(url.includes('file/d/')) id = url.split('file/d/')[1].split('/')[0];
            return id ? `https://docs.google.com/uc?export=download&id=${id}` : url;
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                
                // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É (—Ç—ñ–ª—å–∫–∏ "–ü—Ä–∏–π–Ω—è—Ç–æ")
                const acceptedUsers = data.users.filter(u => u[5] === "–ü—Ä–∏–π–Ω—è—Ç–æ");
                document.getElementById('results-list').innerHTML = acceptedUsers.length > 0 ? 
                acceptedUsers.map(u => `
                    <div class="card">
                        <div class="name">${u[1]}</div>
                        <div class="city-tag">üìç ${u[2]}</div>
                        <audio controls src="${formatDriveUrl(u[3])}"></audio>
                    </div>
                `).join('') : "<p style='text-align:center; color:#555;'>–£—á–∞—Å–Ω–∏–∫—ñ–≤ —â–µ –Ω–µ –ø—Ä–∏–π–Ω—è—Ç–æ</p>";

                // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–¥–º—ñ–Ω–∫–∏
                if(currentUser) {
                    const allUsers = data.users.slice(1);
                    document.getElementById('admin-list').innerHTML = allUsers.map((u, i) => `
                        <div class="card">
                            <div class="name">${u[1]} <span style="font-size:12px; color:var(--accent); opacity:0.7;">[${u[5]}]</span></div>
                            <audio controls src="${formatDriveUrl(u[3])}"></audio>
                            <div class="judge-grid">
                                <div><label>–¢–µ–∫—Å—Ç</label><input type="number" value="0"></div>
                                <div><label>–§–ª–æ—É</label><input type="number" value="0"></div>
                                <div><label>–ü–æ–¥–∞—á–∞</label><input type="number" value="0"></div>
                                <div><label>–í–∞–π–±</label><input type="number" value="0"></div>
                            </div>
                            <button style="margin-top:15px; border-radius:15px; font-size:14px;" onclick="alert('–ë–∞–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!')">–ó–ë–ï–†–ï–ì–¢–ò</button>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function tryLogin() {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                const judge = data.judges.find(j => j[0] == u && j[1] == p);
                if(judge) {
                    currentUser = judge[2];
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    document.getElementById('judge-name').innerText = "–°—É–¥–¥—è: " + currentUser;
                    loadData();
                } else { alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É!"); }
            } catch(e) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º"); }
        }

        document.getElementById('reg-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...";
            btn.disabled = true;

            const file = document.getElementById('reg-file').files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                const payload = {
                    name: document.getElementById('reg-name').value,
                    city: document.getElementById('reg-city').value,
                    fileData: reader.result.split(',')[1],
                    fileName: file.name,
                    mimeType: file.type
                };
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert("–£—Å–ø—ñ—Ö! –¢–≤—ñ–π —Ç—Ä–µ–∫ –≤–∂–µ –Ω–∞ —Ä–æ–∑–≥–ª—è–¥—ñ.");
                    document.getElementById('reg-form').reset();
                } catch(err) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"); }
                btn.innerText = "–ü–û–î–ê–¢–ò –ó–ê–Ø–í–ö–£";
                btn.disabled = false;
            };
            reader.readAsDataURL(file);
        };

        window.onload = loadData;
    </script>
</body>
</html>
